<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel='stylesheet' href='../dist/mapbox-gl.css' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        .buttons-container {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <div id='map'></div>

    <div class="buttons-container">
        <button id="updatesource">update source style</button>
        <button id="updatelayer">update layer style</button>
        delta: <input id="delta" type="number" value="300">
        day: <input id="day" type="number" value="17167">(<span id="day-preview"></span>)
    </div>

    <script src='../dist/mapbox-gl-dev.js'></script>
    <script src='../debug/access_token_generated.js'></script>
    <script>
        const API_GATEWAY = 'https://gateway.api.dev.globalfishingwatch.org/v1'
        // const API_GATEWAY = 'https://gateway.api.globalfishingwatch.org/v1'
        // grab this from api auth
        const GATEWAY_T = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImtpZEtleSJ9.eyJkYXRhIjp7ImZpcnN0TmFtZSI6Ikpvc2UgQW5nZWwiLCJsYXN0TmFtZSI6IlBhcnJlw7FvIE1hZHJpZ2FsICIsImVtYWlsIjoiam9zZWFuZ2VsQGdsb2JhbGZpc2hpbmd3YXRjaC5vcmciLCJwaG90byI6IiIsImlkIjo0NSwidHlwZSI6InVzZXIifSwiaWF0IjoxNjA1ODY0NjU2LCJleHAiOjE2MDU4NjY0NTYsImF1ZCI6ImdmdyIsImlzcyI6ImdmdyJ9.K39HbyE005HTrHJFoVZA1ePXLaHyDeS1rO-U-o08a7lOlhraHsg2_zRb79QH7wa80lh2a9haOXau-5AxgvS6jRTLuHn9qXDuR3E2YYof72_Fc5GAq9TnYQuvqtF488pvoMOXKJfYgFVTnQmuKGC8RKG0wTIUSIf4_4u2vpms8KFfpCl8Sdvby1TJAUZBkXXqy8itWN9lSOjREHyyGvm5bJJeAW4mfNhDvy0v0fLxHup0o-0C-MH0CFQtH6XIWch2w47AB2fNA5XGER0bpBoo5cI9YjYUUpPXaVPXib_YiqYdBXam4KxJwkr4w3bkdkRPAgvEC6SibKIggm6hwtc404Xj0MywuvPDHO_iQ9OVpC2jXWoDcE1QqQVXbRYqNw6k_9M5Pc_wWCkkACLSthIXI2rKiGeEOkxC18eum5KbFBTYQPC3XIO13VOierMCkhqNWdJlJoeQTWXnRYAjLEonF3WORbeC8boljK1x5fRcdbktWeXaKaIDDcoBHC_SRXXR'
        const tileset = 'carriers_v8_hd';
        const baseUrl = `${API_GATEWAY}/datasets/${tileset}/4wings/tile/heatmap/{z}/{x}/{y}`
        const id = 'heatmap';

        let delta = 300
        let day = 17167

        const style = {
            version: 8,
            name: 'temporal grid test',
            glyphs:
                'https://raw.githubusercontent.com/GlobalFishingWatch/map-gl-glyphs/master/_output/{fontstack}/{range}.pbf?raw=true',
            sources: {
                basemap_vector: {
                    type: 'vector',
                    tiles: ['https://storage.googleapis.com/public-tiles/tiles-basemap/{z}/{x}/{y}.pbf'],
                    maxzoom: 8,
                },
                [id]: {
                    type: 'temporalgrid',
                    tiles: [baseUrl],
                },
                'fourwings-dgg_salinity_caribe': {
                    "type": "temporalgrid",
                    "tiles": [
                        "https://gateway.api.dev.globalfishingwatch.org/v1/4wings/tile/heatmap/{z}/{x}/{y}?geomType=rectangle&singleFrame=true&datasets=datasets[0]%3Ddgg_salinity_caribe&date-range=2018-01-01T00%3A00%3A00.000Z%2C2019-12-31T23%3A59%3A59.999Z"
                    ],
                    "maxzoom": 8
                }
            },
            layers: [
                {
                    type: 'fill',
                    id: 'landmass',
                    source: 'basemap_vector',
                    'source-layer': 'landmass',
                    paint: {
                        'fill-color': '#cccccc',
                        'fill-opacity': 0.99,
                    },
                },
                {
                    id,
                    type: 'circle',
                    source: id,
                    'source-layer': 'temporalgrid',
                    paint: {
                        'circle-color': '#0000ff',
                        'circle-radius': 2
                    },
                    layout: {
                        'visibility': 'visible'
                    }
                },
                {
                    id: 'heatmap-values',
                    type: 'symbol',
                    source: id,
                    'source-layer': 'temporalgrid',
                    paint: {
                        'text-halo-color': 'white',
                        'text-halo-width': 2
                    },
                    layout: {
                        'text-field': '{id}',
                        'text-font': ['Roboto Mono Light'],
                        'text-size': 7,
                        'text-allow-overlap': true,
                        'icon-allow-overlap': true,
                    },
                },
                {
                    "id": "fourwings-dgg_salinity_caribe",
                    "source": "fourwings-dgg_salinity_caribe",
                    "source-layer": "temporalgrid",
                    "type": "fill",
                    "layout": {
                        "visibility": "visible"
                    },
                    "paint": {
                        "fill-outline-color": "transparent",
                        "fill-color": [
                            "interpolate",
                            [
                                "linear"
                            ],
                            [
                                "to-number",
                                [
                                    "get",
                                    "value"
                                ]
                            ],
                            31,
                            "rgba(0, 238, 255, 0)",
                            34,
                            "rgba(0, 238, 255, 0.14285714285714285)",
                            34.5,
                            "rgba(0, 238, 255, 0.2857142857142857)",
                            35,
                            "rgba(0, 238, 255, 0.42857142857142855)",
                            35.5,
                            "rgba(0, 238, 255, 0.5714285714285714)",
                            36,
                            "rgba(0, 238, 255, 0.7142857142857143)",
                            36.5,
                            "rgba(0, 238, 255, 0.8571428571428571)",
                            37,
                            "rgba(0, 238, 255, 1)"
                        ]
                    },
                    "metadata": {
                        "color": "#00EEFF",
                        "legend": {
                            "label": "Salinity for caribe",
                            "unit": "PSU",
                            "type": "colorramp",
                            "ramp": [
                                [
                                    31,
                                    "rgba(0, 238, 255, 0)"
                                ],
                                [
                                    34,
                                    "rgba(0, 238, 255, 0.14285714285714285)"
                                ],
                                [
                                    34.5,
                                    "rgba(0, 238, 255, 0.2857142857142857)"
                                ],
                                [
                                    35,
                                    "rgba(0, 238, 255, 0.42857142857142855)"
                                ],
                                [
                                    35.5,
                                    "rgba(0, 238, 255, 0.5714285714285714)"
                                ],
                                [
                                    36,
                                    "rgba(0, 238, 255, 0.7142857142857143)"
                                ],
                                [
                                    36.5,
                                    "rgba(0, 238, 255, 0.8571428571428571)"
                                ],
                                [
                                    37,
                                    "rgba(0, 238, 255, 1)"
                                ]
                            ]
                        },
                        "generatorId": "fourwings-dgg_salinity_caribe",
                        "generatorType": "HEATMAP",
                        "gridArea": null,
                        "currentlyAt": "value",
                        "group": "heatmap"
                    }
                }
            ]
        };


        var map = window.map = new mapboxgl.Map({
            container: 'map',
            zoom: 1,
            center: [1, 1],
            style: style,
            hash: true,
            transformRequest: (url, resourceType) => {
                if (resourceType === 'Tile' && url.includes(API_GATEWAY)) {
                    return {
                        url: url,
                        headers: { 'Authorization': 'Bearer ' + GATEWAY_T }
                    }
                }
            }
        });

        map.showTileBoundaries = true

        map.on('click', (e) => {
            var q = map.queryRenderedFeatures(e.point)
            console.log(q)
        })

        map.on('load', () => {
            // updateDay()
            // updateSource()
        })

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function updateSource() {
            let url = `${baseUrl}?delta=${delta}`
            const s = map.getStyle()
            s.sources[id].tiles = [url]
            console.log(s)
            map.setStyle(s)
            console.log(map.getStyle())
        }

        function updateDay() {
            const s = map.getStyle()
            console.log(s)
            let d = new Date(parseInt(day) * 1000 * 60 * 60 * 24)
            document.getElementById('day-preview').innerText = d

            s.layers[2].layout['text-field'] = `{${day}}`
            map.setStyle(s)
        }


        document.getElementById('updatelayer').addEventListener('click', () => {
            map.setPaintProperty('heatmap', 'circle-color', getRandomColor())
        });

        document.getElementById('updatesource').addEventListener('click', () => {
            updateSource()
        });

        document.getElementById('delta').addEventListener('change', (e) => {
            delta = e.currentTarget.value
            console.log(delta)
            updateSource()
        })

        document.getElementById('day').addEventListener('change', (e) => {
            day = e.currentTarget.value
            console.log(day)
            updateDay()
        })

    </script>
</body>

</html>
